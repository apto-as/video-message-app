# 背景処理機能実装計画

## 技術選定

### 主力技術：rembg
- **理由**：高精度な背景削除、様々な写真に対応、実装の簡単さ
- **対象**：一般的な人物写真（誕生日メッセージに最適）

### 補助技術：MediaPipe
- **理由**：人物検出の精度向上、リアルタイム前処理
- **対象**：品質チェックと前処理フィルター

## 実装アーキテクチャ

### Phase 1: 基本背景削除（Week 1-2）
```
画像アップロード → rembg背景削除 → D-ID API送信
```

### Phase 2: 背景合成機能（Week 3-4）
```
画像アップロード → 人物検出 → 背景削除 → 背景合成 → D-ID API送信
```

### Phase 3: 品質向上（Week 5-6）
```
画像アップロード → MediaPipe品質チェック → rembg処理 → エッジ改良 → 背景合成 → D-ID API送信
```

## 技術スタック詳細

### Backend追加ライブラリ
```
rembg==2.0.56          # 背景削除
pillow==10.1.0         # 画像処理
numpy==1.24.3          # 数値計算
opencv-python==4.8.1.78  # 画像前処理
mediapipe==0.10.8      # 人物検出（Phase 3）
```

### API エンドポイント設計
```
POST /api/process-image
- 元画像アップロード
- 背景削除処理
- 品質チェック
- 処理済み画像返却

POST /api/composite-background
- 人物画像 + 背景画像
- 背景合成処理
- 合成済み画像返却

POST /api/create-video
- 合成画像 + テキスト/音声
- D-ID API連携
- 動画生成
```

## ファイル保存戦略

### 一時保存（開発段階）
```
/tmp/uploads/           # アップロード画像
/tmp/processed/         # 処理済み画像
/tmp/composited/        # 合成画像
```

### 本格運用時の検討事項
- AWS S3 / Google Cloud Storage
- CDN連携
- 自動削除ポリシー（24時間後）

## パフォーマンス目標

| 処理 | 目標時間 | 画像サイズ |
|------|----------|------------|
| 背景削除 | < 3秒 | 1024x1024 |
| 背景合成 | < 2秒 | 1024x1024 |
| 全体処理 | < 8秒 | 1024x1024 |

## 実装優先順位

1. **High Priority**：rembg基本実装
2. **Medium Priority**：背景合成機能
3. **Low Priority**：MediaPipe品質向上

## リスク評価

### 技術リスク
- rembgの処理時間（大容量画像）
- メモリ使用量の増加
- GPU要件（本格運用時）

### 対策
- 画像リサイズ前処理
- 非同期処理の実装
- CPU版での動作確認
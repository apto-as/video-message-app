# Docker Compose Production Configuration for EC2 with CUDA
# Use with: docker-compose -f docker-compose.yml -f docker-compose.prod.yml up -d

version: '3.8'

services:
  openvoice:
    build:
      args:
        # Enable CUDA for EC2 with NVIDIA GPU
        USE_CUDA: "true"
        DEVICE: "cuda"
    environment:
      # Production settings
      - DEVICE=cuda
      - LOG_LEVEL=INFO
    # GPU resource allocation
    deploy:
      resources:
        reservations:
          devices:
            - driver: nvidia
              count: 1
              capabilities: [gpu]
    # Use nvidia-docker runtime (alternative to deploy section)
    # Uncomment if using older Docker versions
    # runtime: nvidia
      
  backend:
    environment:
      # Production settings
      - DEBUG=false
      - RELOAD=false  # Disable hot reload in production
      - ENVIRONMENT=production

  frontend:
    # Use production Dockerfile
    build:
      dockerfile: Dockerfile.production

  nginx:
    # Production SSL configuration
    volumes:
      - ./ssl/letsencrypt:/etc/letsencrypt:ro
      - ./nginx/prod.conf:/etc/nginx/conf.d/default.conf:ro

# Production-specific notes:
# 1. NVIDIA Docker runtime must be installed
#    - Install: https://github.com/NVIDIA/nvidia-docker
# 2. GPU drivers must be properly configured
#    - Verify: nvidia-smi
# 3. Docker Compose GPU support requires Docker 19.03+
#    - Verify: docker --version
# 4. SSL certificates should be managed via Let's Encrypt or AWS Certificate Manager

# Deployment command on EC2:
# docker-compose -f docker-compose.yml -f docker-compose.prod.yml up -d --build

# Health check on EC2:
# curl http://localhost:8001/health
# nvidia-smi  # Check GPU utilization
